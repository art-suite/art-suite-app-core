import &StandardImport, &Fonts

suite:
  tight: ->

    test "layoutMode:tight 64pt well? area and drawArea", ->
      layout = new Layout "well?", {fontSize: 64, fontFamily: "AvenirNext-DemiBold"}, {layoutMode:"tight"}
      bitmap = layout.toBitmap area: :drawArea, background: #ff0
      log scaled: layout.toBitmap scale: 10 area: :drawArea, background: #ff0

      {area, drawArea} = layout
      log {bitmap, size: bitmap.size, layout, area, drawArea}

      assert.within
        area
        rect 0, 0, 153, 49
        rect 0, 0, 154, 50
        :area

      assert.eq
        true
        neq drawArea, area
        && drawArea.contains area.expand .5
        && area.expand(5).contains drawArea
        "drawArea"


    test "layoutMode:tight 64pt", ->
      layout = new Layout "Sing!?!", {fontSize:64}, {layoutMode:"tight"}
      bitmap = layout.toBitmap()
      log {bitmap, size: bitmap.size, layout}
      log scaled: layout.toBitmap scale: 10
      assert.within bitmap.size, point(180, 58), point(183, 61)

    test "layoutMode:tight 16pt", ->
      layout = new Layout "Sing!?!", {fontSize:16}, {layoutMode:"tight"}
      bitmap = layout.toBitmap()
      log {bitmap, size: bitmap.size, layout}
      log scaled: layout.toBitmap scale: 10
      assert.within bitmap.size, point(45, 15), point(45, 15)

    test "layoutMode:tight area and drawArea", ->
      layout = new Layout "Sing!?!", {fontSize:64}, {layoutMode:"tight"}
      bitmap = layout.toBitmap()
      log bitmap
      {area, drawArea} = layout
      assert.within area,      rect(0, 0, 180, 58), rect(0, 0, 181, 59), "area"
      assert.eq
        true
        neq drawArea, area
        && drawArea.contains area.expand .5
        && area.expand(5).contains drawArea
        "drawArea"

  regressions: ->
    test "layoutMode:tight 16pt", ->
      layout = new Layout
        "are awesome"
        fontFamily: "Arial, sans-serif"
        fontSize: 10
        {} layoutMode: :tight
      bitmap = layout.toBitmap()
      log {bitmap, size: bitmap.size, layout}
      log scaled: layout.toBitmap scale: 10
      assert.eq bitmap.size, point 60, 6

  fancyFonts: ->
    global.suiteSetup ->
      Promise.all
        array {tags}, fontName in fonts when /light|dirty/.test tags
          loadFont fontName

    testFancyFont = (font) ->
      test font, ->
        layout = new Layout
          "" Sing!?!
          fontSize: 16
          fontFamily: fonts[font].fontFamily
          {} layoutMode:"tight"

        log {}
          layout.toBitmap()
          scaled: layout.toBitmap scale: 10

    each {tags}, fontName in fonts when /light|dirty/.test tags
      testFancyFont fontName
