import &ArtStandardLib, &ArtEngine, &ArtCanvas

class CoreHelper
  @getDownsampledRedChannel: getDownsampledRedChannel = (bitmap, sliceAmount, options) ->
    bitmap = bitmap.canvasBitmap || bitmap._drawCacheBitmap || bitmap
    {downsampleBits = 4} = options
    out = array a in bitmap.getImageDataArray "red" with a >> downsampleBits
    if sliceAmount
      out.slice 0, sliceAmount
    else
      out

  @compareDownsampledRedChannel: (message, bitmap, compare, options = {}) ->
    bitmap = bitmap.canvasBitmap || bitmap._drawCacheBitmap || bitmap
    log "#{message}": bitmap.clone()
    downsampled = getDownsampledRedChannel bitmap, compare.length, options
    unless eq downsampled, compare
      log compareDownsampledRedChannel:
        this: downsampled
        shouldEqual: compare
        message: message

      assert.eq compare, downsampled, message

  assert.downsampledRedChannelEq = (message, element, compare, options) =>
    if element instanceof CanvasElement
      element.onNextReady (e) -> e.canvasBitmap
    else if element instanceof Bitmap
      element
    else if element instanceof Element
      element.toBitmapBasic()
    else throw new Error "expecting Element, CanvasElement or Bitmap"
    .then (bitmap) =>
      @compareDownsampledRedChannel message, bitmap, compare, downsampleBits: options?.downsampleBits ? 5

  @testDownsampledRedChannelEq: (message, element, compare) =>
    global.test message, ->
      Promise.then -> element
      .then (element) ->
        assert.downsampledRedChannelEq message, element, compare
