import &StandardImport

suite: ->
  test "clipping limits dirty redraw", ->
    log "incrementalCaching 1"
    parent = Element
      key: :parent
      size: 4
      clip: true
      RectangleElement color: #480
      child = Element
        key: :child
        cacheDraw: true
        location: x: 2
        RectangleElement color: #8ff
    log "incrementalCaching 2"
    parent.toBitmapBasic()
    .then (bitmap)->
      log "incrementalCaching 3"

      log initial: {bitmap, _drawCacheBitmap: child._drawCacheBitmap.clone()}
      compareDownsampledRedChannel "partialRedraw clipping", child._drawCacheBitmap, [8, 8, 0, 0], downsampleBits: 4

      child._drawCacheBitmap.clear "black"
      log drawArea: child.drawArea, size: child.currentSize
      log "incrementalCaching 4"
      child.location = x: 1
      log "incrementalCaching 5"
      parent.toBitmapBasic()
    .then (bitmap)->
      log "incrementalCaching 6"
      log incremental: {bitmap}
      compareDownsampledRedChannel "partialRedraw clipping", child._drawCacheBitmap, [0, 0, 8, 0], downsampleBits: 4
